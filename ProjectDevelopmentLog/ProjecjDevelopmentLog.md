---

### **项目名称：基于ESP32-S3的简易数码相框**
**硬件平台：** ESP32-S3, 2.4寸 ST7789 TFT (240x320), MicroSD卡模块
**开发环境：** Arduino IDE
**主要库：** Arduino_GFX, SD, TJpg_Decoder

---

### **2025/12/08：项目定题与选型**
*   **任务：** 确定项目目标和硬件选型。
*   **内容：** 决定制作一个简易的“数码相框”，能够自动轮播SD卡中的照片。
*   **硬件确认：** 手头有一块ESP32-S3开发板和一个ST7789屏幕。
*   **计划：** 预计耗时两周，核心难点在于JPEG解码和屏幕驱动的适配。

### **2025/12/09：硬件连接与驱动测试**
*   **任务：** 连接硬件并点亮屏幕。
*   **实施：**
    *   确定TFT屏幕引脚：DC(41), CS(42), SCK(21), MOSI(47)。
    *   确定SD卡引脚（HSPI模式）：SCK(39), MISO(40), MOSI(38), CS(1)。
*   **代码工作：** 引入 `Arduino_GFX_Library`。配置 `Arduino_ESP32SPI` 和 `Arduino_ST7789` 对象。
*   **结果：** 成功点亮屏幕，显示纯色背景，验证了屏幕驱动配置正确。

### **2025/12/10：SD卡文件系统挂载**
*   **任务：** 实现SD卡读取功能。
*   **遇到的问题：** ESP32S3的SPI引脚定义比较灵活，初期直接使用默认 `SD.begin()` 失败。
*   **解决方案：** 定义了一个独立的 `SPIClass sdSPI(HSPI)`，并在 `setup` 中明确指定引脚 `sdSPI.begin(39, 40, 38, 1)`。
*   **进展：** 串口成功打印出 "SD Card initialized"，文件系统挂载成功。

### **2025/12/11：文件遍历功能开发**
*   **任务：** 读取指定文件夹下的所有文件。
*   **代码逻辑：**
    *   编写 `listJpgFiles` 函数，指定读取 `/PIC` 目录。
    *   增加了文件后缀过滤器 `isJpgFile`，只保留 `.jpg` 或 `.jpeg` 文件。
    *   定义了 `MAX_FILES` 限制为10张，防止内存溢出。
*   **测试：** 在SD卡 `/PIC` 目录下放入几张测试图，串口正确输出了文件名列表。

### **2025/12/12：引入JPEG解码库**
*   **任务：** 将JPG文件解码为RGB数据。
*   **实施：**
    *   引入 `TJpg_Decoder` 库。
    *   编写回调函数 `tft_output`。这是库的核心，它将解码后的 bitmap 数据块通过 `gfx->draw16bitRGBBitmap` 绘制到屏幕上。
*   **问题：** 尝试直接绘制图片，发现大分辨率图片会导致解码缓慢或者只显示一部分。

### **2025/12/13 - 12/15：图片缩放逻辑（攻坚阶段）**
*   **任务：** 解决图片尺寸与屏幕尺寸（240x320）不匹配的问题。
*   **思考：** `TJpg_Decoder` 库支持 1/1, 1/2, 1/4, 1/8 的缩放。不能随意缩放，只能缩小。
*   **代码实现：**
    *   编写 `scalePic` 函数。
    *   使用 `TJpgDec.getSdJpgSize` 先获取图片原始宽高。
    *   **算法逻辑：** 如果宽或高超过屏幕，就尝试缩小2倍；如果还大，就缩小4倍，以此类推。
*   **结果：** 图片能显示在屏幕内了，但全部挤在左上角 (0,0) 位置，且四周留黑不均匀。

### **2025/12/16 - 12/17：居中显示与UI优化**
*   **任务：** 让图片在屏幕正中央显示，提升观感。
*   **修改重点：**
    *   计算缩放后的实际宽高：`scaled_w = w / scale`。
    *   推导居中坐标公式：`x = (屏幕宽 - 图片宽) / 2`。
    *   在 `scalePic` 中应用计算出的 (x, y) 坐标进行绘制。
*   **调试：** 串口打印调试信息 `尺寸: ... -> 缩放: ... -> 位置: ...`，确认计算逻辑无误。现在竖图和横图都能视觉居中了。

### **2025/12/18：幻灯片轮播逻辑完善**
*   **任务：** 将功能整合进 `loop` 循环，实现自动播放。
*   **细节处理：**
    *   **残影问题：** 发现上一张大图切换到下一张小图时，边缘会有残留。
    *   **修复：** 在绘制每一张图之前，强制执行 `gfx->fillScreen(BLACK)` 清屏。
    *   **延时：** 每张图显示后 `delay(2000)`，留出观看时间。
    *   **启动检查：** 在 `setup` 中加入检查，如果没找到图片（`fileCount == 0`），屏幕显示黄色警告，避免程序空跑。

### **2025/12/19：最终测试与代码固化**
*   **任务：** 综合测试与代码整理。
*   **测试场景：**
    *   测试无SD卡情况 -> 屏幕变红提示 "SD Card Failed!" (通过)。
    *   测试文件夹为空 -> 屏幕变黄提示 "No images found!" (通过)。
    *   测试不同比例图片（全景图、正方图） -> 均能自适应缩放并居中 (通过)。
*   **收尾：** 清理无用的注释，确认波特率115200，确认各引脚定义与最终硬件一致。
*   **结论：** 项目开发完成，代码已封存。

---

**[附件]**：最终版代码 `main.ino`.